/*
SunmiBillingApp - Kotlin Android App for Sunmi V2S
Functions:
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
- Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±
- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
- Ø­ÙØ¸ Ù†Ø³Ø®Ø© PDF
- Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù€ Sunmi Print SDK
*/

// MainActivity.kt
class MainActivity : AppCompatActivity() {
    private lateinit var productList: MutableList<Product>
    private lateinit var adapter: ProductAdapter

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        // Ø·Ø¨Ø§Ø¹Ø© Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø±
        SunmiPrintHelper.getInstance().initSunmiPrinterService(this)

        productList = mutableListOf(
            Product("Ø¨ÙŠØ¨Ø³ÙŠ", 3.0),
            Product("Ù…Ø§Ø¡", 2.0)
        )

        adapter = ProductAdapter(productList)
        recyclerView.adapter = adapter

        btnPrint.setOnClickListener {
            val receipt = ReceiptGenerator.generate(productList)
            SunmiPrintHelper.getInstance().printText(receipt)
            SunmiPrintHelper.getInstance().lineWrap(3)
            PDFHelper.saveToPDF(this, receipt)
        }

        btnWhatsApp.setOnClickListener {
            val text = ReceiptGenerator.generate(productList)
            val intent = Intent().apply {
                action = Intent.ACTION_SEND
                putExtra(Intent.EXTRA_TEXT, text)
                type = "text/plain"
                `package` = "com.whatsapp"
            }
            startActivity(intent)
        }
    }
}

// Product.kt
data class Product(val name: String, val price: Double)

// ProductAdapter.kt (Ù„Ù€ RecyclerView)
class ProductAdapter(private val items: List<Product>) : RecyclerView.Adapter<ProductAdapter.ViewHolder>() {
    inner class ViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {
        val name: TextView = itemView.findViewById(R.id.name)
        val price: TextView = itemView.findViewById(R.id.price)
    }

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ViewHolder {
        val view = LayoutInflater.from(parent.context).inflate(R.layout.item_product, parent, false)
        return ViewHolder(view)
    }

    override fun onBindViewHolder(holder: ViewHolder, position: Int) {
        val product = items[position]
        holder.name.text = product.name
        holder.price.text = "${product.price} Ø±ÙŠØ§Ù„"
    }

    override fun getItemCount() = items.size
}

// ReceiptGenerator.kt
object ReceiptGenerator {
    fun generate(products: List<Product>): String {
        val sb = StringBuilder()
        sb.appendLine("Ø³Ù…Ø§Øª Ù„Ù„Ø­Ø§Ø³Ø¨ Ø§Ù„Ø¢Ù„ÙŠ")
        sb.appendLine("Ø£Ø¨Ù‡Ø§ - Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©")
        sb.appendLine("-------------------------")
        var total = 0.0
        for (p in products) {
            sb.appendLine("${p.name}  ${p.price} Ø±ÙŠØ§Ù„")
            total += p.price
        }
        sb.appendLine("-------------------------")
        sb.appendLine("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: $total Ø±ÙŠØ§Ù„")
        sb.appendLine("${getDateTime()}")
        sb.appendLine("Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§ ğŸ¤")
        return sb.toString()
    }

    private fun getDateTime(): String {
        val sdf = SimpleDateFormat("yyyy-MM-dd HH:mm", Locale.getDefault())
        return sdf.format(Date())
    }
}

// PDFHelper.kt
object PDFHelper {
    fun saveToPDF(context: Context, text: String) {
        val dir = File(context.getExternalFilesDir(null), "SunmiInvoices")
        if (!dir.exists()) dir.mkdirs()
        val fileName = "invoice_${System.currentTimeMillis()}.pdf"
        val file = File(dir, fileName)

        val writer = PdfWriter(file)
        val pdfDoc = PdfDocument(writer)
        val document = Document(pdfDoc)
        document.add(Paragraph(text))
        document.close()
    }
}

// AndroidManifest.xml (Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµØ§Ø±ÙŠØ­)
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
